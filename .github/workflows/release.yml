name: Build and Release

on:
  release:
    types: [created]
  push:
    branches: [master]
    paths:
      - 'src-tauri/**'
      - 'src/**'
      - 'src/i18n/**'
      - 'Cargo.toml'

env:
  RUST_VERSION: stable
  NODE_VERSION: '20'

jobs:
  check:
    name: Pre-build Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: rustfmt, clippy

      - name: Check Rust formatting
        run: rustfmt --check src-tauri/src/*.rs 2>/dev/null || true

      - name: Run cargo check
        run: |
          cd src-tauri
          cargo check --message-format=short 2>&1 | head -20 || true

  build-windows:
    name: Build for Windows
    runs-on: windows-latest
    needs: check
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable
          components: rustfmt, clippy

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Dependencies
        run: |
          cd src-tauri
          npm install

      - name: Build with Tauri (Windows)
        id: build-windows
        run: cargo tauri build --bundles msi,zip

      - name: Rename Windows artifacts
        run: |
          cd src-tauri/target/release/bundle
          if (Test-Path "*.msi") { Rename-Item -Path (Get-Item *.msi).Name -NewName "MachineID-Manage-windows-setup.msi" }
          if (Test-Path "*.zip") { Rename-Item -Path (Get-Item *.zip).Name -NewName "MachineID-Manage-windows-portable.zip" }

      - name: Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: src-tauri/target/release/bundle/**
          retention-days: 5

  build-macos:
    name: Build for macOS
    runs-on: macos-latest
    needs: check
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable
          components: rustfmt, clippy

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Dependencies
        run: |
          cd src-tauri
          npm install

      - name: Build with Tauri (macOS)
        id: build-macos
        run: cargo tauri build --bundles dmg,app,zip

      - name: Rename macOS artifacts
        run: |
          cd src-tauri/target/release/bundle
          if (Test-Path "*.dmg") { Rename-Item -Path (Get-Item *.dmg).Name -NewName "MachineID-Manage-macos-setup.dmg" }
          if (Test-Path "*.zip") { Rename-Item -Path (Get-Item *.zip).Name -NewName "MachineID-Manage-macos-portable.zip" }

      - name: Upload macOS Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-artifacts
          path: src-tauri/target/release/bundle/**
          retention-days: 5

  build-ubuntu:
    name: Build for Ubuntu
    runs-on: ubuntu-latest
    needs: check
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable
          components: rustfmt, clippy

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Dependencies
        run: |
          cd src-tauri
          npm install

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y webkit2gtk4.0 libgtk-3-dev libayatana-appindicator3-dev librsvg2-dev

      - name: Build with Tauri (Ubuntu)
        id: build-ubuntu
        run: cargo tauri build --bundles deb,appimage,zip

      - name: Rename Ubuntu artifacts
        run: |
          cd src-tauri/target/release/bundle
          if (Test-Path "*.deb") { Rename-Item -Path (Get-Item *.deb).Name -NewName "MachineID-Manage-ubuntu-setup.deb" }
          if (Test-Path "*.appimage") { Rename-Item -Path (Get-Item *.appimage).Name -NewName "MachineID-Manage-ubuntu-portable.AppImage" }
          if (Test-Path "*.zip") { Rename-Item -Path (Get-Item *.zip).Name -NewName "MachineID-Manage-ubuntu-portable.zip" }

      - name: Upload Ubuntu Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ubuntu-artifacts
          path: src-tauri/target/release/bundle/**
          retention-days: 5

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-windows, build-macos, build-ubuntu]
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create Release with Bilingual Notes
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**
          body: |
            # MachineID-Manage v${{ github.event.release.tag_name }}

            ## About / å…³äº
            MachineID-Manage is a Windows MachineGuid management tool built with Rust + Tauri 2.
            MachineID-Manage æ˜¯ä¸€æ¬¾åŸºäº Rust + Tauri 2 å¼€å‘çš„ Windows æœºå™¨ç ç®¡ç†å·¥å…·ã€‚

            ## Features / åŠŸèƒ½ç‰¹æ€§
            - ğŸ“– Read MachineGuid / è¯»å–æœºå™¨ç 
            - ğŸ’¾ Backup Management / å¤‡ä»½ç®¡ç†
            - ğŸ”„ Restore Backup / æ¢å¤å¤‡ä»½
            - ğŸ² Random Generation / éšæœºç”Ÿæˆ
            - ğŸ”§ Custom Replace / è‡ªå®šä¹‰æ›¿æ¢
            - ğŸ“‹ Copy Function / å¤åˆ¶åŠŸèƒ½

            ## Downloads / ä¸‹è½½è¯´æ˜

            ### Windows
            - MachineID-Manage-windows-setup.msi (Installer)
            - MachineID-Manage-windows-portable.zip (Portable)

            ### macOS
            - MachineID-Manage-macos-setup.dmg (Installer)
            - MachineID-Manage-macos-portable.zip (Portable)

            ### Ubuntu/Linux
            - MachineID-Manage-ubuntu-setup.deb (Installer)
            - MachineID-Manage-ubuntu-portable.AppImage (Portable)

            ## Usage / ä½¿ç”¨æ–¹æ³•
            1. Download the installer for your platform
            2. Install and run the application
            3. Use administrator privileges for modifications

            ## Precautions / æ³¨æ„äº‹é¡¹
            âš ï¸ WARNING: Modifying Windows Registry carries risks! Please backup first!

            ## System Requirements / ç³»ç»Ÿè¦æ±‚
            - Windows 10/11
            - Administrator privileges required

            ---
            View full documentation: https://github.com/luxiaosen8/MachineID-Manage
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  create-draft-release:
    name: Create Draft Release (for testing)
    runs-on: ubuntu-latest
    needs: [build-windows, build-macos, build-ubuntu]
    if: github.event_name == 'release'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create Draft Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**
          draft: true
          body: |
            # MachineID-Manage v${{ github.event.release.tag_name }}

            ## Downloads / ä¸‹è½½
            Please download the installer for your system below.

            ### Windows
            - MachineID-Manage-windows-setup.msi (Installer)
            - MachineID-Manage-windows-portable.zip (Portable)

            ### macOS
            - MachineID-Manage-macos-setup.dmg (Installer)
            - MachineID-Manage-macos-portable.zip (Portable)

            ### Ubuntu/Linux
            - MachineID-Manage-ubuntu-setup.deb (Installer)
            - MachineID-Manage-ubuntu-portable.AppImage (Portable)

            ## Features / åŠŸèƒ½
            - ğŸ“– Read MachineGuid / è¯»å–æœºå™¨ç 
            - ğŸ’¾ Backup Management / å¤‡ä»½ç®¡ç†
            - ğŸ”„ Restore Backup / æ¢å¤å¤‡ä»½
            - ğŸ² Random Generation / éšæœºç”Ÿæˆ
            - ğŸ”§ Custom Replace / è‡ªå®šä¹‰æ›¿æ¢
            - ğŸ“‹ Copy Function / å¤åˆ¶åŠŸèƒ½

            ## Precautions / æ³¨æ„äº‹é¡¹
            - Modifying registry carries risks, please backup first!
            - Administrator privileges required
            - Windows only

            ## Usage / ä½¿ç”¨æ–¹æ³•
            1. Download and install the version for your system
            2. Run as administrator
            3. Perform machine ID operations

            ## System Requirements / ç³»ç»Ÿè¦æ±‚
            - Windows 10/11
            - Administrator privileges

            ---
            Homepage: https://github.com/luxiaosen8/MachineID-Manage
            Issues: https://github.com/luxiaosen8/MachineID-Manage/issues
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
