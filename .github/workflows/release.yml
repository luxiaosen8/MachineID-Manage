name: Build and Release

on:
  release:
    types: [created]
  push:
    branches: [master]
    paths:
      - 'src-tauri/**'
      - 'src/**'
      - 'Cargo.toml'

env:
  RUST_VERSION: stable
  NODE_VERSION: '20'

jobs:
  check:
    name: Pre-build Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: rustfmt, clippy

      - name: Check Rust formatting
        run: rustfmt --check src-tauri/src/*.rs 2>/dev/null || true

      - name: Run cargo check
        run: |
          cd src-tauri
          cargo check --message-format=short 2>&1 | head -20 || true

  build-windows:
    name: Build for Windows
    runs-on: windows-latest
    needs: check
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable
          components: rustfmt, clippy

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Dependencies
        run: npm ci

      - name: Build with Tauri (Windows)
        id: build-windows
        run: |
          cd src-tauri
          cargo tauri build --bundles msi,zip,updater
        env:
          TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}

      - name: Rename Windows artifacts
        run: |
          cd src-tauri/target/release/bundle
          if (Test-Path "*.msi") { Rename-Item -Path (Get-Item *.msi).Name -NewName "MachineID-Manage-windows-setup.msi" }
          if (Test-Path "*.zip") { Rename-Item -Path (Get-Item *.zip).Name -NewName "MachineID-Manage-windows-portable.zip" }

      - name: Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: src-tauri/target/release/bundle/**
          retention-days: 5

  build-macos:
    name: Build for macOS
    runs-on: macos-latest
    needs: check
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable
          components: rustfmt, clippy

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Dependencies
        run: npm ci

      - name: Build with Tauri (macOS)
        id: build-macos
        run: |
          cd src-tauri
          cargo tauri build --bundles dmg,app,zip,updater
        env:
          TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}

      - name: Rename macOS artifacts
        run: |
          cd src-tauri/target/release/bundle
          if (Test-Path "*.dmg") { Rename-Item -Path (Get-Item *.dmg).Name -NewName "MachineID-Manage-macos-setup.dmg" }
          if (Test-Path "*.zip") { Rename-Item -Path (Get-Item *.zip).Name -NewName "MachineID-Manage-macos-portable.zip" }

      - name: Upload macOS Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-artifacts
          path: src-tauri/target/release/bundle/**
          retention-days: 5

  build-ubuntu:
    name: Build for Ubuntu
    runs-on: ubuntu-latest
    needs: check
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable
          components: rustfmt, clippy

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Dependencies
        run: npm ci

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y webkit2gtk4.0 libgtk-3-dev libayatana-appindicator3-dev librsvg2-dev

      - name: Build with Tauri (Ubuntu)
        id: build-ubuntu
        run: |
          cd src-tauri
          cargo tauri build --bundles deb,appimage,zip,updater
        env:
          TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}

      - name: Rename Ubuntu artifacts
        run: |
          cd src-tauri/target/release/bundle
          if (Test-Path "*.deb") { Rename-Item -Path (Get-Item *.deb).Name -NewName "MachineID-Manage-ubuntu-setup.deb" }
          if (Test-Path "*.appimage") { Rename-Item -Path (Get-Item *.appimage).Name -NewName "MachineID-Manage-ubuntu-portable.AppImage" }
          if (Test-Path "*.zip") { Rename-Item -Path (Get-Item *.zip).Name -NewName "MachineID-Manage-ubuntu-portable.zip" }

      - name: Upload Ubuntu Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ubuntu-artifacts
          path: src-tauri/target/release/bundle/**
          retention-days: 5

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-windows, build-macos, build-ubuntu]
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create Release with Bilingual Notes
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**
          body: |
            # MachineID-Manage v${{ github.event.release.tag_name }}

            ## å…³äº / About
            MachineID-Manage æ˜¯ä¸€æ¬¾åŸºäº **Rust + Tauri 2** å¼€å‘çš„ Windows æœºå™¨ç ç®¡ç†å·¥å…·ã€‚
            MachineID-Manage is a Windows MachineGuid management tool built with Rust + Tauri 2.

            ## åŠŸèƒ½ç‰¹æ€§ / Features
            - ğŸ“– è¯»å–æœºå™¨ç  / Read MachineGuid
            - ğŸ’¾ å¤‡ä»½ç®¡ç† / Backup management
            - ğŸ”„ æ¢å¤å¤‡ä»½ / Restore backup
            - ğŸ² éšæœºç”Ÿæˆ / Random generation
            - ğŸ”§ è‡ªå®šä¹‰æ›¿æ¢ / Custom replacement
            - ğŸ“‹ ä¸€é”®å¤åˆ¶ / One-click copy

            ## ä¸‹è½½è¯´æ˜ / Download Instructions

            ### Windows
            - `MachineID-Manage-windows-setup.msi` - å®‰è£…ç‰ˆ (æ¨è)
            - `MachineID-Manage-windows-portable.zip` - å…å®‰è£…ç‰ˆ

            ### macOS
            - `MachineID-Manage-macos-setup.dmg` - å®‰è£…ç‰ˆ (æ¨è)
            - `MachineID-Manage-macos-portable.zip` - å…å®‰è£…ç‰ˆ

            ### Ubuntu/Linux
            - `MachineID-Manage-ubuntu-setup.deb` - å®‰è£…ç‰ˆ (æ¨è)
            - `MachineID-Manage-ubuntu-portable.AppImage` - å…å®‰è£…ç‰ˆ

            ## ä½¿ç”¨æ–¹æ³• / Usage
            1. ä¸‹è½½å¯¹åº”å¹³å°çš„å®‰è£…åŒ…
            2. å®‰è£…å¹¶è¿è¡Œç¨‹åº
            3. ä½¿ç”¨ç®¡ç†å‘˜æƒé™æ‰§è¡Œæœºå™¨ç æ“ä½œ

            ## æ³¨æ„äº‹é¡¹ / Notes
            âš ï¸ ä¿®æ”¹æ³¨å†Œè¡¨å­˜åœ¨é£é™©ï¼Œè¯·åŠ¡å¿…å…ˆå¤‡ä»½ï¼

            ## ç³»ç»Ÿè¦æ±‚ / System Requirements
            - Windows 10/11
            - ç®¡ç†å‘˜æƒé™ï¼ˆä¿®æ”¹æ—¶éœ€è¦ï¼‰

            ---
            æŸ¥çœ‹å®Œæ•´æ–‡æ¡£ / View full documentation: https://github.com/luxiaosen8/MachineID-Manage
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  create-draft-release:
    name: Create Draft Release (for testing)
    runs-on: ubuntu-latest
    needs: [build-windows, build-macos, build-ubuntu]
    if: github.event_name == 'release'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create Draft Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**
          draft: true
          body: |
            # MachineID-Manage v${{ github.event.release.tag_name }}

            ## ğŸ“¥ ä¸‹è½½ / Downloads
            è¯·ä¸‹è½½ä¸‹æ–¹å¯¹åº”æ‚¨ç³»ç»Ÿçš„å®‰è£…åŒ…ã€‚
            Please download the installer for your system below.

            ### Windows
            - â¬‡ï¸ `MachineID-Manage-windows-setup.msi` - å®‰è£…ç‰ˆ Installer
            - ğŸ“¦ `MachineID-Manage-windows-portable.zip` - å…å®‰è£… Portable

            ### macOS
            - â¬‡ï¸ `MachineID-Manage-macos-setup.dmg` - å®‰è£…ç‰ˆ Installer
            - ğŸ“¦ `MachineID-Manage-macos-portable.zip` - å…å®‰è£… Portable

            ### Ubuntu/Linux
            - â¬‡ï¸ `MachineID-Manage-ubuntu-setup.deb` - å®‰è£…ç‰ˆ Installer
            - ğŸ“¦ `MachineID-Manage-ubuntu-portable.AppImage` - å…å®‰è£… Portable

            ## âœ¨ åŠŸèƒ½ / Features
            - ğŸ“– è¯»å–æœºå™¨ç  / Read MachineGuid
            - ğŸ’¾ å¤‡ä»½ç®¡ç† / Backup management
            - ğŸ”„ æ¢å¤å¤‡ä»½ / Restore backup
            - ğŸ² éšæœºç”Ÿæˆ / Random generation
            - ğŸ”§ è‡ªå®šä¹‰æ›¿æ¢ / Custom replacement
            - ğŸ“‹ ä¸€é”®å¤åˆ¶ / One-click copy

            ## âš ï¸ æ³¨æ„äº‹é¡¹ / Precautions
            - ä¿®æ”¹æ³¨å†Œè¡¨å­˜åœ¨é£é™©ï¼Œè¯·åŠ¡å¿…å…ˆå¤‡ä»½ï¼
            - Modifying registry carries risks, please backup first!
            - éœ€è¦ç®¡ç†å‘˜æƒé™ / Administrator privileges required
            - ä»…æ”¯æŒ Windows / Windows only

            ## ğŸ“– ä½¿ç”¨æ–¹æ³• / How to Use
            1. ä¸‹è½½å¹¶å®‰è£…å¯¹åº”ç‰ˆæœ¬
            2. ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œç¨‹åº
            3. æ‰§è¡Œæ‰€éœ€çš„æœºå™¨ç æ“ä½œ

            ## ğŸ› ï¸ ç³»ç»Ÿè¦æ±‚ / System Requirements
            - Windows 10/11
            - ç®¡ç†å‘˜æƒé™

            ---
            ğŸŒ é¡¹ç›®ä¸»é¡µ / Homepage: https://github.com/luxiaosen8/MachineID-Manage
            ğŸ“‹ é—®é¢˜åé¦ˆ / Issues: https://github.com/luxiaosen8/MachineID-Manage/issues
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
