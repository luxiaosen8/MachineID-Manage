name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            artifact-name: windows
          - os: ubuntu-22.04
            artifact-name: linux
          - os: macos-latest
            artifact-name: macos

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: ./src-tauri -> target

      - name: Install dependencies (Ubuntu)
        if: matrix.os == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends --no-install-suggests \
            curl libwebkit2gtk-4.1-dev build-essential libssl-dev libgtk-3-dev \
            libayatana-appindicator3-dev librsvg2-dev patchelf libfuse2 file

      - name: Install tauri-cli
        run: cargo install tauri-cli --locked --version "^2"

      - name: Build with Tauri
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        working-directory: src-tauri
        run: cargo tauri build --verbose

      - name: Create portable package (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $portableDir = Join-Path $env:GITHUB_WORKSPACE "portable"
          if (Test-Path $portableDir) { Remove-Item -Recurse -Force $portableDir }
          New-Item -ItemType Directory -Path $portableDir | Out-Null
          Copy-Item (Join-Path $env:GITHUB_WORKSPACE "src-tauri\\target\\release\\machineid-manage.exe") $portableDir
          $resourcesDir = Join-Path $env:GITHUB_WORKSPACE "src-tauri\\target\\release\\resources"
          if (Test-Path $resourcesDir) {
            Copy-Item $resourcesDir (Join-Path $portableDir "resources") -Recurse
          }
          Compress-Archive -Path (Join-Path $portableDir "*") -DestinationPath (Join-Path $env:GITHUB_WORKSPACE "MachineID-Manage_Portable_Windows.zip") -Force

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}
          path: |
            src-tauri/target/release/bundle/
            src-tauri/target/release/machineid-manage.exe
            MachineID-Manage_Portable_Windows.zip
          if-no-files-found: error

  create-release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows
          path: release-artifacts

      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux
          path: release-artifacts

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos
          path: release-artifacts

      - name: Get version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: release-artifacts/**
          name: MachineID-Manage v${{ steps.version.outputs.version }}
          body: |
            ## MachineID-Manage v${{ steps.version.outputs.version }}

            ### 下载 / Downloads

            #### Windows
            - 安装包：MSI Installer
            - 便携版：MachineID-Manage_Portable_Windows.zip

            #### Linux
            - DEB Package / AppImage（如有）

            #### macOS
            - DMG Installer（如有）

            ### 使用方法 / Usage

            #### 中文
            1. 以管理员身份运行（写入注册表需要管理员权限）
            2. 读取当前 MachineGuid
            3. 备份当前机器码
            4. 选择随机生成或自定义替换
            5. 如需回滚，从备份列表恢复

            #### English
            1. Run as Administrator (required for registry writes)
            2. Read current MachineGuid
            3. Backup current machine id
            4. Random generate or custom replace
            5. Restore from backups if needed

            ### 安全提示 / Security

            > ⚠️ 修改注册表前请务必备份 / Always backup before modifying registry.

            ### Source Code

            [View on GitHub](https://github.com/luxiaosen8/MachineID-Manage)
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
