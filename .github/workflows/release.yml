name: Release Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v2.0.0)'
        required: true
        default: 'v2.0.0'

permissions:
  contents: write

jobs:
  # Windows Build
  release-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          target: x86_64-pc-windows-msvc

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          rustup default stable
          npm install
          cargo install tauri-cli --locked

      - name: Build with Tauri
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cargo tauri build --verbose 2>&1
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Build failed with exit code $LASTEXITCODE"
            exit 1
          }

      - name: Create Portable Version
        shell: pwsh
        run: |
          $version = "${{ github.event.inputs.version || github.ref_name }}"
          $version = $version -replace '^v', ''
          $portableDir = "MachineID-Manage_${version}_windows_portable"
          New-Item -ItemType Directory -Force -Path $portableDir
          Copy-Item "src-tauri/target/release/machineid-manage.exe" $portableDir/
          Copy-Item "src-tauri/icons" $portableDir/ -Recurse
          Compress-Archive -Path $portableDir -DestinationPath "${portableDir}.zip" -Force

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: |
            src-tauri/target/release/bundle/
            MachineID-Manage_*_windows_portable.zip
          retention-days: 30

  # macOS Build
  release-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin,aarch64-apple-darwin

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          rustup default stable
          npm install
          cargo install tauri-cli --locked

      - name: Build with Tauri
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cargo tauri build --verbose

      - name: Create Portable Version
        run: |
          VERSION="${{ github.event.inputs.version || github.ref_name }}"
          VERSION=${VERSION#v}
          PORTABLE_DIR="MachineID-Manage_${VERSION}_macos_portable"
          mkdir -p "$PORTABLE_DIR"
          cp "src-tauri/target/release/machineid-manage" "$PORTABLE_DIR/"
          cp -r "src-tauri/icons" "$PORTABLE_DIR/"
          zip -r "${PORTABLE_DIR}.zip" "$PORTABLE_DIR"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-release
          path: |
            src-tauri/target/release/bundle/
            MachineID-Manage_*_macos_portable.zip
          retention-days: 30

  # Linux Build
  release-linux:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          rustup default stable
          npm install
          cargo install tauri-cli --locked
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Build with Tauri
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cargo tauri build --verbose

      - name: Create Portable Version
        run: |
          VERSION="${{ github.event.inputs.version || github.ref_name }}"
          VERSION=${VERSION#v}
          PORTABLE_DIR="MachineID-Manage_${VERSION}_linux_portable"
          mkdir -p "$PORTABLE_DIR"
          cp "src-tauri/target/release/machineid-manage" "$PORTABLE_DIR/"
          cp -r "src-tauri/icons" "$PORTABLE_DIR/"
          tar -czf "${PORTABLE_DIR}.tar.gz" "$PORTABLE_DIR"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-release
          path: |
            src-tauri/target/release/bundle/
            MachineID-Manage_*_linux_portable.tar.gz
          retention-days: 30

  # Create Release
  create-release:
    needs: [release-windows, release-macos, release-linux]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.version || github.ref_name }}
          name: MachineID-Manage ${{ github.event.inputs.version || github.ref_name }}
          body: |
            ## ğŸ‰ MachineID-Manage v2.0.0 æ­£å¼å‘å¸ƒ

            ### âœ¨ å…¨æ–°é‡æ„ç‰ˆæœ¬
            - å‰ç«¯å…¨é¢å‡çº§ä¸º **Vue 3 + TypeScript**
            - ä½¿ç”¨ **Vite** æ„å»ºå·¥å…·ï¼Œå¼€å‘ä½“éªŒå¤§å¹…æå‡
            - **Tailwind CSS** ç°ä»£åŒ– UI è®¾è®¡
            - **Pinia** çŠ¶æ€ç®¡ç†
            - Tauri 2.0 æœ€æ–°ç‰¹æ€§æ”¯æŒ

            ### ğŸ“¦ ä¸‹è½½

            #### Windows
            - å®‰è£…ç‰ˆ: `.msi` æˆ– `.exe`
            - ä¾¿æºç‰ˆ: `MachineID-Manage_*_windows_portable.zip`

            #### macOS
            - å®‰è£…ç‰ˆ: `.dmg`
            - ä¾¿æºç‰ˆ: `MachineID-Manage_*_macos_portable.zip`

            #### Linux
            - å®‰è£…ç‰ˆ: `.AppImage` æˆ– `.deb`
            - ä¾¿æºç‰ˆ: `MachineID-Manage_*_linux_portable.tar.gz`

            ### ğŸš€ å¿«é€Ÿå¼€å§‹

            #### ä¸­æ–‡
            1. **è¯»å–æœºå™¨ç ** - åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨è¯»å–å½“å‰ MachineGuid
            2. **å¤‡ä»½æœºå™¨ç ** - ç‚¹å‡»"å¤‡ä»½æœºå™¨ç "ä¿å­˜å½“å‰æœºå™¨ç 
            3. **éšæœºç”Ÿæˆ** - ç‚¹å‡»"éšæœºç”Ÿæˆ"åˆ›å»ºæ–°çš„éšæœº GUID
            4. **è‡ªå®šä¹‰æ›¿æ¢** - è¾“å…¥æœ‰æ•ˆçš„ GUID å¹¶ç¡®è®¤æ›¿æ¢
            5. **æ¢å¤å¤‡ä»½** - åœ¨å¤‡ä»½åˆ—è¡¨ä¸­é€‰æ‹©å¹¶æ¢å¤

            #### English
            1. **Read Machine ID** - Automatically reads current MachineGuid on app startup
            2. **Backup Machine ID** - Click "Backup Machine ID" to save current machine code
            3. **Random Generation** - Click "Random Generate" to create a new random GUID
            4. **Custom Replacement** - Enter a valid GUID and confirm replacement
            5. **Restore Backup** - Select and restore from the backup list

            ### âš ï¸ æ³¨æ„äº‹é¡¹ / Notes

            #### ä¸­æ–‡
            - ä¿®æ”¹ Windows æ³¨å†Œè¡¨éœ€è¦**ç®¡ç†å‘˜æƒé™**
            - æ‰§è¡Œä»»ä½•æ“ä½œå‰è¯·åŠ¡å¿…å¤‡ä»½æ‚¨çš„æ•°æ®
            - å»ºè®®åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯åå†ç”¨äºç”Ÿäº§ç¯å¢ƒ
            - æœ¬å·¥å…·ä»…é€‚ç”¨äº Windows ç³»ç»Ÿ

            #### English
            - **Administrator privileges** required for modifying Windows registry
            - Always backup your data before performing any operations
            - Recommended to test in a test environment before production use
            - This tool is designed for Windows systems only

            ### ğŸ›¡ï¸ å®‰å…¨ç‰¹æ€§ / Security Features

            #### ä¸­æ–‡
            - âœ… æƒé™æ£€æµ‹ - å†™å…¥æ“ä½œå‰æ£€æµ‹ç®¡ç†å‘˜æƒé™
            - âœ… è‡ªåŠ¨å¤‡ä»½ - ä¿®æ”¹å‰è‡ªåŠ¨å¤‡ä»½
            - âœ… ç”¨æˆ·ç¡®è®¤ - å±é™©æ“ä½œéœ€è¦ç”¨æˆ·ç¡®è®¤
            - âœ… æ“ä½œæ—¥å¿— - è®°å½•æ‰€æœ‰æ³¨å†Œè¡¨ä¿®æ”¹æ“ä½œ
            - âœ… è¾“å…¥éªŒè¯ - å†™å…¥å‰éªŒè¯ GUID æ ¼å¼

            #### English
            - âœ… Permission Detection - Checks admin rights before write operations
            - âœ… Auto Backup - Automatically backs up before modifications
            - âœ… User Confirmation - Dangerous operations require user confirmation
            - âœ… Operation Logging - Records all registry modification operations
            - âœ… Input Validation - Validates GUID format before writing

            ### ğŸ“‹ æ›´æ–°çŠ¶æ€ / Update Status

            #### ä¸­æ–‡
            - **ç‰ˆæœ¬**: v2.0.0
            - **å‘å¸ƒæ—¥æœŸ**: 2026-01-29
            - **çŠ¶æ€**: ç¨³å®šç‰ˆæœ¬
            - **å…¼å®¹æ€§**: Windows 10/11

            #### English
            - **Version**: v2.0.0
            - **Release Date**: 2026-01-29
            - **Status**: Stable Release
            - **Compatibility**: Windows 10/11

            ### ğŸ”§ æŠ€æœ¯æ ˆ / Tech Stack
            - **Backend**: Rust + Tauri 2
            - **Frontend**: Vue 3 + TypeScript
            - **Build Tool**: Vite
            - **State Management**: Pinia
            - **Styling**: Tailwind CSS

            ---
            **æ„Ÿè°¢ä½¿ç”¨ MachineID-Manage! / Thank you for using MachineID-Manage!**
          files: |
            artifacts/windows-release/**/**
            artifacts/macos-release/**/**
            artifacts/linux-release/**/**
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
