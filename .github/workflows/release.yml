name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.5.0)'
        required: true
        default: 'v1.5.0'

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'windows-latest'
            args: '--target x86_64-pc-windows-msvc'
            name: 'Windows x64'
          - platform: 'macos-latest'
            args: '--target x86_64-apple-darwin'
            name: 'macOS x64'
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin'
            name: 'macOS ARM64'
          - platform: 'ubuntu-22.04'
            args: '--target x86_64-unknown-linux-gnu'
            name: 'Linux x64'

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Rust
        uses: dtolnay/rust-action@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'x86_64-apple-darwin,aarch64-apple-darwin' || matrix.platform == 'windows-latest' && 'x86_64-pc-windows-msvc' || 'x86_64-unknown-linux-gnu' }}

      - name: Install dependencies (Ubuntu only)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Install frontend dependencies
        run: npm install

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ github.event.inputs.version || github.ref_name }}
          releaseName: 'MachineID-Manage ${{ github.event.inputs.version || github.ref_name }}'
          releaseBody: |
            ## MachineID-Manage ${{ github.event.inputs.version || github.ref_name }}

            ### ä¸‹è½½ / Download

            | å¹³å° / Platform | å®‰è£…ç‰ˆ / Installer | ä¾¿æºç‰ˆ / Portable |
            |:---------------:|:------------------:|:-----------------:|
            | Windows x64 | `.msi`, `.exe` | `.zip` |
            | macOS x64 | `.dmg` | `.app.tar.gz` |
            | macOS ARM64 | `.dmg` | `.app.tar.gz` |
            | Linux x64 | `.deb`, `.AppImage` | `.AppImage` |

            ### ä½¿ç”¨æ–¹æ³• / Usage

            #### Windows
            1. ä¸‹è½½å®‰è£…ç‰ˆæˆ–ä¾¿æºç‰ˆ
            2. ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œç¨‹åº
            3. è¯»å–ã€å¤‡ä»½æˆ–ä¿®æ”¹ MachineGuid

            #### macOS
            1. ä¸‹è½½ `.dmg` æ–‡ä»¶
            2. å°†åº”ç”¨æ‹–åˆ° Applications æ–‡ä»¶å¤¹
            3. è¿è¡Œç¨‹åºï¼ˆä»…æ”¯æŒè¯»å–å’Œå¤‡ä»½åŠŸèƒ½ï¼‰

            #### Linux
            1. ä¸‹è½½ `.AppImage` æˆ– `.deb` åŒ…
            2. ç»™äºˆæ‰§è¡Œæƒé™ï¼ˆAppImageï¼‰
            3. ä»¥ root æƒé™è¿è¡Œï¼ˆéœ€è¦æ—¶ï¼‰

            ### æ³¨æ„äº‹é¡¹ / Notes

            - âš ï¸ **Windows**: ä¿®æ”¹æ³¨å†Œè¡¨éœ€è¦ç®¡ç†å‘˜æƒé™
            - âš ï¸ **macOS**: ä»…æ”¯æŒè¯»å–å’Œå¤‡ä»½ï¼Œä¸æ”¯æŒå†™å…¥
            - âš ï¸ **Linux**: å†™å…¥æ“ä½œéœ€è¦ root æƒé™
            - âš ï¸ ä¿®æ”¹å‰è¯·åŠ¡å¿…å¤‡ä»½æ‚¨çš„ MachineGuid

            ### ä¸»è¦åŠŸèƒ½ / Features

            - ğŸ“– è¯»å– MachineGuid / Read MachineGuid
            - ğŸ’¾ å¤‡ä»½ç®¡ç† / Backup Management
            - ğŸ”„ æ¢å¤å¤‡ä»½ / Restore Backup
            - ğŸ² éšæœºç”Ÿæˆ / Random Generation
            - ğŸ”§ è‡ªå®šä¹‰æ›¿æ¢ / Custom Replace
            - ğŸ“‹ å¤åˆ¶åŠŸèƒ½ / Copy Function

            ### æ›´æ–°æ—¥å¿— / Changelog

            - æ–°å¢è·¨å¹³å°æ”¯æŒï¼ˆWindowsã€macOSã€Linuxï¼‰
            - ä¼˜åŒ–å‰ç«¯å¼¹çª—æ ·å¼
            - æ·»åŠ ç»Ÿä¸€ç¡®è®¤å¯¹è¯æ¡†
            - æ”¹è¿›å›½é™…åŒ–æ”¯æŒ

            ---

            **Full Changelog**: https://github.com/${{ github.repository }}/compare/${{ github.event.inputs.version || github.ref_name }}^...${{ github.event.inputs.version || github.ref_name }}
          releaseDraft: false
          prerelease: false
          args: ${{ matrix.args }}

  update-readme:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update README with latest release
        run: |
          VERSION=${{ github.event.inputs.version || github.ref_name }}
          echo "Updating README for version $VERSION"
          # è¿™é‡Œå¯ä»¥æ·»åŠ è‡ªåŠ¨æ›´æ–° README ç‰ˆæœ¬çš„è„šæœ¬

      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md README.zh-CN.md || true
          git commit -m "docs: update version to ${{ github.event.inputs.version || github.ref_name }}" || true
          git push || true
