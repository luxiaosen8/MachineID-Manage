name: Release Build

on:
  push:
    tags:
      - 'v*'
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v2.0.0)'
        required: true
        default: 'v2.0.0'

permissions:
  contents: write

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥ (ä¸é˜»å¡å‘å¸ƒ)
  quality-check:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install
          cd src-tauri && cargo fetch

      - name: Rust Format Check
        run: |
          cd src-tauri && cargo fmt -- --check
        continue-on-error: true

      - name: Rust Clippy Check
        run: |
          cd src-tauri && cargo clippy --all-targets --all-features -- -W warnings
        continue-on-error: true

      - name: TypeScript Lint
        run: |
          npm run lint
        continue-on-error: true

      - name: TypeScript Type Check
        run: |
          npm run type-check || npm run build
        continue-on-error: true

  # å®‰å…¨å®¡è®¡ (ä¸é˜»å¡å‘å¸ƒ)
  security-audit:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run cargo-audit
        run: |
          cd src-tauri && cargo audit || true

      - name: Run npm audit
        run: npm audit --audit-level=high || true

  # å•å…ƒæµ‹è¯• (ä¸é˜»å¡å‘å¸ƒ)
  test:
    runs-on: windows-latest
    continue-on-error: true
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install
          cd src-tauri && cargo fetch

      - name: Run Rust Tests
        run: |
          cd src-tauri && cargo test --verbose
        continue-on-error: true

      - name: Run TypeScript Tests
        run: |
          npm run test:unit || npm test || echo "No tests configured"
        continue-on-error: true

  # Windows Build Only
  release-windows:
    # ä¸ä¾èµ–å…¶ä»–ä»»åŠ¡ï¼Œç›´æ¥è¿è¡Œ
    runs-on: windows-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          target: x86_64-pc-windows-msvc

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          rustup default stable
          npm install
          cargo install tauri-cli --locked

      - name: Build with Tauri
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cargo tauri build --verbose 2>&1
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Build failed with exit code $LASTEXITCODE"
            exit 1
          }

      - name: Create Portable Version
        shell: pwsh
        run: |
          $version = "${{ github.event.inputs.version || github.ref_name }}"
          $version = $version -replace '^v', ''
          $portableDir = "MachineID-Manage_${version}_windows_portable"
          New-Item -ItemType Directory -Force -Path $portableDir
          # æŸ¥æ‰¾æ„å»ºåçš„å¯æ‰§è¡Œæ–‡ä»¶
          $exePath = "src-tauri/target/release/machineid-manage.exe"
          if (-not (Test-Path $exePath)) {
            $exePath = "target/release/machineid-manage.exe"
          }
          Write-Host "Using executable at: $exePath"
          Copy-Item $exePath $portableDir/
          if (Test-Path "src-tauri/icons") {
            Copy-Item "src-tauri/icons" $portableDir/ -Recurse
          }
          Compress-Archive -Path $portableDir -DestinationPath "${portableDir}.zip" -Force

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: |
            target/release/bundle/msi/*.msi
            target/release/bundle/nsis/*.exe
            MachineID-Manage_*_windows_portable.zip
          retention-days: 30

  # Create Release
  create-release:
    needs: [release-windows]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-release
          path: artifacts

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.version || github.ref_name }}
          name: MachineID-Manage ${{ github.event.inputs.version || github.ref_name }}
          body: |
            ## ğŸ‰ MachineID-Manage v2.1.0 æ­£å¼å‘å¸ƒ

            ### ğŸ”§ é‡è¦ä¿®å¤
            - ä¿®å¤ UAC æƒé™æå‡é—®é¢˜ - ä½¿ç”¨åŸç”Ÿ Windows API `ShellExecuteW` æ›¿ä»£ PowerShell
            - æ”¹è¿›é”™è¯¯å¤„ç† - æ·»åŠ è¯¦ç»†çš„é”™è¯¯ä»£ç å’Œç”¨æˆ·å‹å¥½çš„é”™è¯¯æ¶ˆæ¯
            - æå‡ç¨³å®šæ€§ - ç®¡ç†å‘˜é‡å¯åŠŸèƒ½ç°åœ¨å¯ä»¥æ­£å¸¸å·¥ä½œ

            ### âœ¨ v2.0 å…¨æ–°é‡æ„ç‰ˆæœ¬ç‰¹æ€§
            - å‰ç«¯å…¨é¢å‡çº§ä¸º **Vue 3 + TypeScript**
            - ä½¿ç”¨ **Vite** æ„å»ºå·¥å…·ï¼Œå¼€å‘ä½“éªŒå¤§å¹…æå‡
            - **Tailwind CSS** ç°ä»£åŒ– UI è®¾è®¡
            - **Pinia** çŠ¶æ€ç®¡ç†
            - Tauri 2.0 æœ€æ–°ç‰¹æ€§æ”¯æŒ

            ### ğŸ“¦ ä¸‹è½½ / Downloads

            | å¹³å° | å®‰è£…ç‰ˆ | ä¾¿æºç‰ˆ |
            |------|--------|--------|
            | Windows x64 | `MachineID-Manage_2.1.0_x64-setup.exe` | `MachineID-Manage_2.1.0_windows_portable.zip` |
            | Windows MSI | `MachineID-Manage_2.1.0_x64_en-US.msi` | - |

            > **æ³¨æ„ / Note**: æœ¬å·¥å…·ä¸“ä¸º Windows ç³»ç»Ÿè®¾è®¡ï¼Œä»…æ”¯æŒ Windows 10/11 å¹³å°

            ### ğŸš€ å¿«é€Ÿå¼€å§‹ / Quick Start

            #### ä¸­æ–‡
            1. **è¯»å–æœºå™¨ç ** - åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨è¯»å–å½“å‰ MachineGuid
            2. **å¤‡ä»½æœºå™¨ç ** - ç‚¹å‡»"å¤‡ä»½æœºå™¨ç "ä¿å­˜å½“å‰æœºå™¨ç 
            3. **éšæœºç”Ÿæˆ** - ç‚¹å‡»"éšæœºç”Ÿæˆ"åˆ›å»ºæ–°çš„éšæœº GUID
            4. **è‡ªå®šä¹‰æ›¿æ¢** - è¾“å…¥æœ‰æ•ˆçš„ GUID å¹¶ç¡®è®¤æ›¿æ¢
            5. **æ¢å¤å¤‡ä»½** - åœ¨å¤‡ä»½åˆ—è¡¨ä¸­é€‰æ‹©å¹¶æ¢å¤

            #### English
            1. **Read Machine ID** - Automatically reads current MachineGuid on app startup
            2. **Backup Machine ID** - Click "Backup Machine ID" to save current machine code
            3. **Random Generation** - Click "Random Generate" to create a new random GUID
            4. **Custom Replacement** - Enter a valid GUID and confirm replacement
            5. **Restore Backup** - Select and restore from the backup list

            ### âš ï¸ æ³¨æ„äº‹é¡¹ / Notes

            #### ä¸­æ–‡
            - ä¿®æ”¹ Windows æ³¨å†Œè¡¨éœ€è¦**ç®¡ç†å‘˜æƒé™**
            - æ‰§è¡Œä»»ä½•æ“ä½œå‰è¯·åŠ¡å¿…å¤‡ä»½æ‚¨çš„æ•°æ®
            - å»ºè®®åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯åå†ç”¨äºç”Ÿäº§ç¯å¢ƒ
            - æœ¬å·¥å…·ä»…é€‚ç”¨äº Windows ç³»ç»Ÿ
            - **v2.1.0 ä¿®å¤**: ç®¡ç†å‘˜æƒé™ç”³è¯·ç°åœ¨å¯ä»¥æ­£å¸¸å·¥ä½œ

            #### English
            - **Administrator privileges** required for modifying Windows registry
            - Always backup your data before performing any operations
            - Recommended to test in a test environment before production use
            - This tool is designed for Windows systems only
            - **v2.1.0 Fix**: Admin privilege request now works correctly

            ### ğŸ›¡ï¸ å®‰å…¨ç‰¹æ€§ / Security Features

            #### ä¸­æ–‡
            - âœ… æƒé™æ£€æµ‹ - å†™å…¥æ“ä½œå‰æ£€æµ‹ç®¡ç†å‘˜æƒé™
            - âœ… è‡ªåŠ¨å¤‡ä»½ - ä¿®æ”¹å‰è‡ªåŠ¨å¤‡ä»½
            - âœ… ç”¨æˆ·ç¡®è®¤ - å±é™©æ“ä½œéœ€è¦ç”¨æˆ·ç¡®è®¤
            - âœ… æ“ä½œæ—¥å¿— - è®°å½•æ‰€æœ‰æ³¨å†Œè¡¨ä¿®æ”¹æ“ä½œ
            - âœ… è¾“å…¥éªŒè¯ - å†™å…¥å‰éªŒè¯ GUID æ ¼å¼

            #### English
            - âœ… Permission Detection - Checks admin rights before write operations
            - âœ… Auto Backup - Automatically backs up before modifications
            - âœ… User Confirmation - Dangerous operations require user confirmation
            - âœ… Operation Logging - Records all registry modification operations
            - âœ… Input Validation - Validates GUID format before writing

            ### ğŸ“‹ æ›´æ–°çŠ¶æ€ / Update Status

            #### ä¸­æ–‡
            - **ç‰ˆæœ¬**: v2.1.0
            - **å‘å¸ƒæ—¥æœŸ**: 2026-01-29
            - **çŠ¶æ€**: ç¨³å®šç‰ˆæœ¬
            - **å…¼å®¹æ€§**: Windows 10/11
            - **ä¸»è¦æ›´æ–°**: ä¿®å¤ UAC ææƒé—®é¢˜

            #### English
            - **Version**: v2.1.0
            - **Release Date**: 2026-01-29
            - **Status**: Stable Release
            - **Compatibility**: Windows 10/11
            - **Major Update**: Fixed UAC elevation issue

            ### ğŸ”§ æŠ€æœ¯æ ˆ / Tech Stack
            - **Backend**: Rust + Tauri 2
            - **Frontend**: Vue 3 + TypeScript
            - **Build Tool**: Vite
            - **State Management**: Pinia
            - **Styling**: Tailwind CSS
            - **Windows API**: ShellExecuteW for UAC elevation

            ---
            **æ„Ÿè°¢ä½¿ç”¨ MachineID-Manage! / Thank you for using MachineID-Manage!**
          files: |
            artifacts/**
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
